
import pandas as pd
import snowflake.connector
import os
import yaml

# Cargar credenciales desde YAML
def load_snowflake_credentials():
    yaml_path = os.path.join(get_repo_path(), 'snowflake.yaml')
    with open(yaml_path, 'r') as file:
        config = yaml.safe_load(file)
    return config['default']

# Establecer conexiÃ³n con Snowflake utilizando el conector oficial
def create_snowflake_connection():
    credentials = load_snowflake_credentials()
    conn = snowflake.connector.connect(
        user=credentials['SNOWFLAKE_USER'],
        password=credentials['SNOWFLAKE_PASSWORD'],
        account=credentials['SNOWFLAKE_ACCOUNT'],
        warehouse='COMPUTE_WH',
        database='INSTACART_DB',
        schema='RAW'
    )
    return conn

# BLOQUE 1: Data Loader
@data_loader
def load_data(*args, **kwargs):
    conn = create_snowflake_connection()
    tables = ['ORDERS', 'PRODUCTS', 'AISLES', 'DEPARTMENTS', 'USERS']
    data = {}

    for table in tables:
        print(f"ðŸ”„ Cargando {table} desde Snowflake...")
        query = f"SELECT * FROM RAW.{table}"
        
        # Ejecutar la consulta correctamente con pd.read_sql
        df = pd.read_sql(query, conn)  
        data[table] = df

        print(f"âœ… Tabla {table} cargada exitosamente.")

    conn.close()  # Cerrar la conexiÃ³n despuÃ©s de cargar los datos
    return data
